import{g as v,C as r,t as n,h as y,c as P,P as w,b as l,w as A,j as g,d as h,e as L,f as b}from"./compositor-BIMduNM-.js";const{state:j}=r,N=async i=>{const t=v();if(!t)return;const o={...t.props,...i.props},e=await r.clients.LiveApi().collection.updateCollection({collectionId:t.id,updateMask:["metadata"],metadata:{...t.metadata,props:o}});await n("UserChanged",e.collection)},D=async i=>{const t=v().id,{source:o}=await r.clients.LiveApi().source.createSource({metadata:{props:i.props||{}},collectionId:t,address:i.address,preview:{webrtc:{enabled:!0,displayName:i.displayName||"RTMP Source"}}});await n("SourceAdded",o);const e=await r.clients.LiveApi().source.addSourceToProject({collectionId:t,projectId:i.projectId,sourceId:o.sourceId});return await n("ProjectSourceAdded",{projectId:e.project.projectId,source:o}),o},R=async i=>{const t=v().id;let o=[],e={};i.metadata&&(o.push("metadata"),e.metadata=i.metadata),i.displayName&&(o.push("preview.webrtc.displayName"),e={...e,preview:{webrtc:{displayName:i.displayName}}});const{source:c}=await r.clients.LiveApi().source.updateSource({collectionId:t,updateMask:o,sourceId:i.sourceId,...e});return await n("SourceChanged",c),c},S=async i=>{const t=v().id;await r.clients.LiveApi().source.removeSourceFromProject({collectionId:t,projectId:i.projectId,sourceId:i.sourceId}),await n("ProjectSourceRemoved",{projectId:i.projectId,sourceId:i.sourceId});const o=await r.clients.LiveApi().source.deleteSource({sourceId:i.sourceId,collectionId:t});return await n("SourceRemoved",i.sourceId),o},f=async(i={})=>{const{props:t={},size:o,settings:e={}}=i,c=await r.Request.createProject({settings:e,props:t,size:o});await n("ProjectAdded",c.project);const s=await y(c.project,"ROLE_HOST");return P(s)},k=async i=>{const{projectId:t,props:o={}}=i,e=v().id,c=await r.clients.LiveApi().project.getProject({collectionId:e,projectId:t,status:!0});if([w.PROJECT_BROADCAST_PHASE_RUNNING,w.PROJECT_BROADCAST_PHASE_STARTING].includes(c.status.phase))return;const s=c.project.metadata||{},{layoutId:a}=s,{video:d}=c.project.rendering,{type:p}=c.project.metadata.props||{},I=await r.Request.createLayout({collectionId:e,projectId:t,type:p||"sceneless",settings:{},size:{x:d.width,y:d.height}}),m=await r.clients.LiveApi().project.updateProject({collectionId:e,projectId:t,updateMask:["metadata"],metadata:{...s,layoutId:I.id}});r.log.debug("New layout assigned to project:",{layout:I}),await n("ProjectChanged",{project:m.project}),await r.clients.LayoutApi().layout.deleteLayout({layoutId:a}),r.log.debug("Previous layout deleted:",{layoutId:a});const u=await y(m.project,"ROLE_HOST");return await u.compositor.update(u.compositor.getRoot().id,o),{project:P(u),internalProject:u}},T=async i=>{const{projectId:t}=i;await r.Request.deleteProject({projectId:t}),await n("ProjectRemoved",{projectId:t})},M=async i=>{const{projectId:t}=i,o=v().id,e=l(t),c={...e.props,...i.props},s=await r.clients.LiveApi().project.updateProject({collectionId:o,projectId:t,updateMask:["metadata"],metadata:{...e.videoApi.project.metadata,props:c}});await n("ProjectChanged",{project:s.project})},B=async i=>{const{projectId:t}=i,o=v().id,e=l(t),c={...e.props,...i.props};await r.clients.LiveApi().project.updateProject({collectionId:o,projectId:t,updateMask:["metadata"],metadata:{...e.videoApi.project.metadata,props:c}})},U=async i=>{const t=j.projects.find(e=>e.id===i.projectId);if(!t){j.activeProjectId=null,n("ActiveProjectChanged",{projectId:null});return}const o=j.projects.find(e=>e.id===j.activeProjectId);if(t!==o)return o&&(Array.from(A.rooms.keys()).map(A.removeRoom),await r.clients.LayoutApi().unsubscribeFromLayout(o.layoutApi.layoutId),await r.clients.LiveApi().unsubscribeFromProject(o.videoApi.project.collectionId,o.videoApi.project.projectId),await r.clients.LiveApi().unsubscribeFromCollection(o.videoApi.project.collectionId)),await r.clients.LayoutApi().subscribeToLayout(t.layoutApi.layoutId),await r.clients.LiveApi().subscribeToProject(t.videoApi.project.collectionId,t.videoApi.project.projectId),await r.clients.LiveApi().subscribeToCollection(t.videoApi.project.collectionId),r.clients.LiveApi().project.getProject({collectionId:t.videoApi.project.collectionId,projectId:t.videoApi.project.projectId,status:!0}).then(e=>{var c,s;n("ProjectChanged",{project:e.project,phase:(c=e.status)==null?void 0:c.phase,broadcastId:(s=e.status)==null?void 0:s.broadcastId})}),n("ActiveProjectChanged",{projectId:t.id}),P(t)},O=async i=>{const{projectId:t,displayName:o="Guest"}=i,e=j.projects.find(u=>u.id===t);let c=e.sfuToken;if(!c){let{webrtcAccess:u}=await r.clients.LiveApi().authentication.createWebRtcAccessToken({collectionId:e.videoApi.project.collectionId,projectId:e.videoApi.project.projectId,displayName:o});c=u.accessToken}const a=g(c).video.room,d=new URL(r.clients.getLiveKitServer()),p=d.host+d.pathname,I=A.ensureRoom(p,a,c);I.bindApiClient(r.clients),await I.connect(),e.sfuToken=c,e.roomId=a;const m=h(a);return L("RoomJoined",{projectId:e.id,room:m}),m},_=async i=>{let{props:t={},parentId:o,index:e,projectId:c=j.activeProjectId}=i;const s=l(c),a=await s.compositor.insert(t,o,e);return n("NodeAdded",{projectId:c,nodeId:a}),n("NodeChanged",{projectId:c,nodeId:o}),s.compositor.get(a)},E=async i=>{var s;let{nodeId:t,projectId:o=j.activeProjectId}=i;const e=l(o),c=(s=e.compositor.getParent(t))==null?void 0:s.id;e.compositor.remove(t),n("NodeRemoved",{projectId:o,nodeId:t}),n("NodeChanged",{projectId:o,nodeId:c})},x=async i=>{let{nodeId:t,props:o={},projectId:e=j.activeProjectId}=i;const c=l(e);return delete o.type,delete o.sourceType,c.compositor.update(t,o),n("NodeChanged",{projectId:e,nodeId:t}),c.compositor.get(t)},F=async i=>{let{nodeId:t,layout:o,projectId:e=j.activeProjectId,layoutProps:c={}}=i;l(e).compositor.update(t,{layout:o,layoutProps:c}),n("NodeChanged",{projectId:e,nodeId:t})},H=async i=>{const{nodeId:t,parentId:o,projectId:e=j.activeProjectId,index:c}=i;l(e).compositor.move(t,o,c),n("NodeChanged",{projectId:e,nodeId:t})},K=async i=>{var d,p;const{nodeAId:t,nodeBId:o,projectId:e=j.activeProjectId}=i,c=l(e),s=(d=c.compositor.getParent(t))==null?void 0:d.id,a=(p=c.compositor.getParent(o))==null?void 0:p.id;c.compositor.swap(t,o),n("NodeChanged",{projectId:e,nodeId:s}),n("NodeChanged",{projectId:e,nodeId:a})},q=async i=>{const{parentId:t,childIds:o,projectId:e=j.activeProjectId}=i;l(e).compositor.reorder(t,o),n("NodeChanged",{projectId:e,nodeId:t})},G=async i=>{const{projectId:t=j.activeProjectId,dynamicSources:o,props:e}=i,c=l(t);await r.clients.LiveApi().project.startProjectBroadcast({collectionId:c.videoApi.project.collectionId,projectId:c.videoApi.project.projectId,...o&&{dynamicSources:o},...e&&{triggerMetadata:{...e}}})},J=async i=>{const{projectId:t=j.activeProjectId}=i,o=l(t);await r.clients.LiveApi().project.stopProjectBroadcast({collectionId:o.videoApi.project.collectionId,projectId:o.videoApi.project.projectId})},z=async i=>{var I;const{rtmpUrl:t,rtmpKey:o,enabled:e,projectId:c=j.activeProjectId,props:s={}}=i,a=l(c),d={rtmpPush:{key:o,url:t}},p=await((I=r.clients.LiveApi().destination)==null?void 0:I.createDestination({collectionId:a.videoApi.project.collectionId,projectId:a.videoApi.project.projectId,address:d,enabled:e,metadata:{props:s}}));return await n("DestinationAdded",p.destination),b(p.destination)},W=async i=>{var c;const{destinationId:t,projectId:o=j.activeProjectId}=i,e=l(o);await((c=r.clients.LiveApi().destination)==null?void 0:c.deleteDestination({collectionId:e.videoApi.project.collectionId,projectId:e.videoApi.project.projectId,destinationId:t})),await n("DestinationRemoved",{projectId:o,destinationId:t})},Q=async i=>{var p;const{rtmpUrl:t,rtmpKey:o,destinationId:e,projectId:c=j.activeProjectId}=i,s=l(c),a={key:o,url:t},d=await((p=r.clients.LiveApi().destination)==null?void 0:p.updateDestination({collectionId:s.videoApi.project.collectionId,projectId:s.videoApi.project.projectId,destinationId:e,updateMask:["address.rtmpPush"],address:{rtmpPush:a}}));await n("DestinationChanged",d.destination)},V=async i=>{var d,p;const{projectId:t=j.activeProjectId,destinationId:o,props:e={}}=i,c=l(t),s=c.videoApi.project.destinations.find(I=>I.destinationId===o);if(!s)return;const a=await((p=r.clients.LiveApi().destination)==null?void 0:p.updateDestination({collectionId:c.videoApi.project.collectionId,projectId:c.videoApi.project.projectId,destinationId:o,updateMask:["metadata"],metadata:{...s.metadata||{},props:{...((d=s.metadata)==null?void 0:d.props)||{},...e}}}));await n("DestinationChanged",a.destination)},X=async i=>{var d;const{enabled:t,destinationId:o,projectId:e=j.activeProjectId}=i,c=l(e);if(c.videoApi.project.destinations.find(p=>o===p.destinationId).enabled===t)return;const a=await((d=r.clients.LiveApi().destination)==null?void 0:d.updateDestination({collectionId:c.videoApi.project.collectionId,projectId:c.videoApi.project.projectId,destinationId:o,updateMask:["enabled"],enabled:t}));await n("DestinationChanged",a.destination)},Y=async i=>{var d,p;const{rtmpUrl:t,rtmpKey:o,projectId:e=j.activeProjectId}=i,c=l(e),s={key:o,url:t},a=!0;if(c.videoApi.project.destinations.length>0){const I=await((d=r.clients.LiveApi().destination)==null?void 0:d.updateDestination({collectionId:c.videoApi.project.collectionId,projectId:c.videoApi.project.projectId,destinationId:c.videoApi.project.destinations[0].destinationId,updateMask:["address.rtmpPush"],address:{rtmpPush:s}}));await n("DestinationChanged",I.destination)}else{const I=await((p=r.clients.LiveApi().destination)==null?void 0:p.createDestination({collectionId:c.videoApi.project.collectionId,projectId:c.videoApi.project.projectId,address:{rtmpPush:s},enabled:a}));await n("DestinationAdded",I.destination)}};export{z as addDestination,_ as createNode,f as createProject,D as createSource,E as deleteNode,T as deleteProject,S as deleteSource,O as joinRoom,H as moveNode,k as recreateLayout,W as removeDestination,q as reorderNodes,U as setActiveProject,Y as setDestination,X as setDestinationEnabled,F as setNodeLayout,G as startBroadcast,J as stopBroadcast,K as swapNodes,Q as updateDestination,V as updateDestinationProps,x as updateNode,M as updateProjectProps,B as updateProjectPropsWithoutTrigger,R as updateSource,N as updateUserProps};
//# sourceMappingURL=commands-CIRz5iyl.js.map
